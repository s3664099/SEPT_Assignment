sudo: false

language:
  - minimal

services:
  - docker
  
cache:
  directories:
    - "$HOME/google-cloud-sdk/"
  
before_install:
  # [START auth]
  # Decrypt the credentials we added to the repo using the key we added with the Travis command line tool

  - openssl aes-256-cbc -K $encrypted_988292aa886d_key -iv $encrypted_988292aa886d_iv -in credentials.tar.gz.enc -out credentials.tar.gz -d
  # If the SDK is not already cached, download it and unpack it
  - if [ ! -d ${HOME}/google-cloud-sdk ]; then
       curl https://sdk.cloud.google.com | bash;
    fi
  - tar -xzf credentials.tar.gz
  - mkdir -p lib

  # Here we use the decrypted service account credentials to authenticate the command line tool
  - gcloud auth activate-service-account --key-file client-secret.json

  # [END auth]

  - docker build -t high5app .
  - docker run -d high5app

install:
  # Set the correct project to deploy to
  - gcloud config set project high5softwarept 
  - docker ps | grep -q high5app

deploy:
  provider: gae
  keyfile: credentials.tar.gz.enc
  project: high5softwarept
  skip-cleanup: true
  on:
    branch: development


